"use strict";function sortByKey(e,o){return e.sort(function(e,a){var r=e[o],t=a[o];return r<t?1:r>t?-1:0})}var googleMap=googleMap||{},google=google;googleMap.markers=[];var directionsService=new google.maps.DirectionsService;google.maps.Circle.prototype.contains=function(e){return this.getBounds().contains(e)&&google.maps.geometry.spherical.computeDistanceBetween(this.getCenter(),e)<=this.getRadius()},googleMap.mapSetup=function(){$(".searchSubmit").on("click",this.getSearchLocation.bind(this)),$(".searchClear").on("click",this.clearSearch.bind(this));var e=document.getElementById("map-canvas"),o={zoom:11,center:new google.maps.LatLng(51.50853,(-.12574)),mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(e,o),this.getProperties()},googleMap.getProperties=function(e){var o=this;return googleMap.directionsDisplay=new google.maps.DirectionsRenderer,googleMap.directionsDisplay.setOptions({preserveViewport:!0}),googleMap.directionsDisplay.setMap(googleMap.map),$.get("http://localhost:3000/properties").done(function(a){var r=a.properties.filter(function(o){function a(e){return parseInt(e.split(",").join(""))}var r=new google.maps.LatLng(o.latitude,o.longitude),t=!e||e.contains(r),n=o.num_bedrooms===$(".searchBedrooms").val()||1===o.num_bedrooms&&"Studio"===$(".searchBedrooms").val()||o.num_bedrooms>=4&&"4+"===$(".searchBedrooms").val()||"Bedrooms"===$(".searchBedrooms").val(),i=a(o.price),s=a($(".minPrice").val()),l=a($(".maxPrice").val()),p=(i>=s||isNaN(s))&&(i<=l||isNaN(l));return t&&n&&p});o.loopThroughProperties(r)})},googleMap.loopThroughProperties=function(e){for(var o=sortByKey(e,"date"),a=0;a<Math.min(parseInt($(".numberOfProperties").val()),o.length);a++)googleMap.createMarkerForProperty(o[a])},googleMap.createMarkerForProperty=function(e){var o=new google.maps.LatLng(e.latitude,e.longitude),a=new google.maps.Marker({position:o,map:this.map});googleMap.markers.push(a),googleMap.addInfoWindowForProperty(e,a)},googleMap.addInfoWindowForProperty=function(e,o){google.maps.event.addListener(o,"click",function(){var a=new google.maps.LatLng(e.latitude,e.longitude),r=$(".commuteForm").val();r?googleMap.calcRoute(a,r,function(){googleMap.addInfoWindow(e,o)}):googleMap.addInfoWindow(e,o)})},googleMap.addInfoWindow=function(e,o){$("#mySidenav").style.width="250px","undefined"!=typeof this.infoWindow&&this.infoWindow.close(),e.squareFeet?this.infoWindow=new google.maps.InfoWindow({content:'\n      <h4 class="markerHead"><a href="'+e.details_url+'">'+e.num_bedrooms+" bed "+e.property_type+'</a></h4>\n      <img src="'+(e.image_80_60_url||"")+'">\n      <p class="address">'+e.displayable_address+'</p>\n      <p class="price">£'+parseInt(e.price).toLocaleString()+'</p>\n      <p class="squareFeet">'+e.squareFeet+' square feet</p>\n      <p class="pricePerSquareFoot">£'+parseInt(e.pricePerSquareFoot)+' per square foot</p>\n      <p class="commuteTime">'+googleMap.commuteTime+"</p>\n      "}):this.infoWindow=new google.maps.InfoWindow({content:'\n      <h4 class="markerHead"><a href="'+e.details_url+'">'+e.num_bedrooms+" bed "+e.property_type+'</a></h4>\n      <img src="'+(e.image_80_60_url||"")+'">\n      <p class="address">'+e.displayable_address+'</p>\n      <p class="price">£'+parseInt(e.price).toLocaleString()+'</p>\n      <p class="commuteTime">'+googleMap.commuteTime+"</p>\n      "}),this.infoWindow.open(this.map,o)},googleMap.getSearchLocation=function(e){e&&e.preventDefault();var o=!0,a=!1,r=void 0;try{for(var t,n=googleMap.markers[Symbol.iterator]();!(o=(t=n.next()).done);o=!0){var i=t.value;i.setMap(null)}}catch(e){a=!0,r=e}finally{try{!o&&n.return&&n.return()}finally{if(a)throw r}}googleMap.markers=[];var s=$(".locationForm").val(),l=1e3*parseInt($(".searchRadius").val())||2500,p="https://maps.googleapis.com/maps/api/geocode/json?address="+s+"&bounds=0.3170,%2051.7360|-0.6553,%2051.2503&components=administrative_area:England&key=AIzaSyAzPfoyVbxG2oz378kpMkMszn2XtZn-1SU";s?$.get(p).done(function(e){var o=e.results[0].geometry.location.lat,a=e.results[0].geometry.location.lng,r=new google.maps.LatLng(o,a),t=new google.maps.Marker({position:r,animation:google.maps.Animation.DROP,icon:{path:google.maps.SymbolPath.CIRCLE,scale:4},map:googleMap.map});googleMap.markers.push(t),googleMap.searchCircle=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.15,map:googleMap.map,center:r,radius:l}),googleMap.getProperties(googleMap.searchCircle)}):googleMap.getProperties()},googleMap.clearSearch=function(e){e&&e.preventDefault(),$(".locationForm").val(""),$(".commuteForm").val(""),$(".searchRadius").val("Radius"),$(".minPrice").val("Min price"),$(".maxPrice").val("Max price"),$(".searchBedrooms").val("Bedrooms"),googleMap.commuteTime="";var o=!0,a=!1,r=void 0;try{for(var t,n=googleMap.markers[Symbol.iterator]();!(o=(t=n.next()).done);o=!0){var i=t.value;i.setMap(null)}}catch(e){a=!0,r=e}finally{try{!o&&n.return&&n.return()}finally{if(a)throw r}}googleMap.markers=[],googleMap.searchCircle&&googleMap.searchCircle.setMap(null),null!==googleMap.directionsDisplay&&(googleMap.directionsDisplay.setMap(null),googleMap.directionsDisplay=null),googleMap.getProperties()},googleMap.calcRoute=function(e,o,a){var r=e,t=o,n={origin:r,destination:t,travelMode:"TRANSIT"};directionsService.route(n,function(e,o){"OK"===o?(googleMap.directionsDisplay.setDirections(e),googleMap.commuteTime="Commute time: "+e.routes[0].legs[0].duration.text,a()):(console.log(o),a())})},$(googleMap.mapSetup.bind(googleMap));